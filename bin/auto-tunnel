#!/bin/bash

# AutoSSH Tunnel Manager
# Standalone script to manage SSH tunnels for web and ssh

PID_FILE="$HOME/tunnel/auto-tunnel.pid"
REMOTE_HOST="terrapc"
REMOTE_WEB=9006
REMOTE_SSH=9008

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
# No Color
NC='\033[0m' 

# Function to print colored output
print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# Check if tunnels are running
check_running() {
    if [ -f "$PID_FILE" ]; then
        while read pid; do
            if ps -p "$pid" > /dev/null 2>&1; then
                return 0
            fi
        done < "$PID_FILE"
    fi
    return 1
}

# Start the tunnels
start_tunnels() {
    if check_running; then
        print_warning "Tunnels are already running!"
        status_tunnels
        exit 0
    fi

    print_status "Starting SSH tunnels to $REMOTE_HOST..."
    
    # Remove old PID file if it exists
    [ -f "$PID_FILE" ] && rm -f "$PID_FILE"
    
    # Start first tunnel: port "$REMOTE_WEB" -> localhost:5000
    #autossh -f -N \
        #-R 0.0.0.0:"$REMOTE_WEB":localhost:9009 "$REMOTE_HOST"
    autossh -f -N \
      -o ServerAliveInterval=30 \
      -o ServerAliveCountMax=3 \
      -o ExitOnForwardFailure=yes \
      -R 0.0.0.0:"$REMOTE_WEB":localhost:9009 "$REMOTE_HOST"        
    
    if [ $? -eq 0 ]; then
        # Get the PID of the autossh process we just started
        TUNNEL1_PID=$(pgrep -f "autossh.*"$REMOTE_WEB".*$REMOTE_HOST" | tail -1)
        echo "$TUNNEL1_PID" >> "$PID_FILE"
        print_status "Tunnel 1 started (PID: $TUNNEL1_PID) - "$REMOTE_WEB":localhost:9009"
    else
        print_error "Failed to start tunnel 1"
        exit 1
    fi
    
    sleep 1
    
    # Start second tunnel: port "$REMOTE_SSH" -> localhost:22
    #autossh -f -N \
    #    -R 0.0.0.0:"$REMOTE_SSH":localhost:22 "$REMOTE_HOST"
    autossh -f -N \
        -o ServerAliveInterval=30 \
        -o ServerAliveCountMax=3 \
        -o ExitOnForwardFailure=yes \
        -R 0.0.0.0:"$REMOTE_SSH":localhost:22 "$REMOTE_HOST"    
    
    if [ $? -eq 0 ]; then
        # Get the PID of the autossh process we just started
        TUNNEL2_PID=$(pgrep -f "autossh.*"$REMOTE_SSH".*$REMOTE_HOST" | tail -1)
        echo "$TUNNEL2_PID" >> "$PID_FILE"
        print_status "Tunnel 2 started (PID: $TUNNEL2_PID) - "$REMOTE_SSH":localhost:22"
    else
        print_error "Failed to start tunnel 2"
        stop_tunnels
        exit 1
    fi
    
    print_status "All tunnels started successfully!"
    sleep 1
    status_tunnels
}

# Stop the tunnels
stop_tunnels() {
    if ! check_running; then
        print_warning "No tunnels are running"
        # Clean up PID file anyway
        [ -f "$PID_FILE" ] && rm -f "$PID_FILE"
        return 0
    fi
    
    print_status "Stopping SSH tunnels..."
    
    if [ -f "$PID_FILE" ]; then
        while read pid; do
            if ps -p "$pid" > /dev/null 2>&1; then
                print_info "Stopping process $pid..."
                kill "$pid"
            fi
        done < "$PID_FILE"
        
        # Wait for graceful shutdown
        sleep 3
        
        # Check if any processes are still alive and force kill if necessary
        while read pid; do
            if ps -p "$pid" > /dev/null 2>&1; then
                print_warning "Force killing process $pid..."
                kill -9 "$pid"
            fi
        done < "$PID_FILE"
        
        rm -f "$PID_FILE"
    fi
    
    # Double-check for any remaining autossh processes to gigapc
    if pgrep -f "autossh.*$REMOTE_HOST" > /dev/null; then
        print_warning "Found orphaned autossh processes, cleaning up..."
        pkill -f "autossh.*$REMOTE_HOST"
        sleep 2
        # Force kill if still there
        pkill -9 -f "autossh.*$REMOTE_HOST" 2>/dev/null
    fi
    
    print_status "All tunnels stopped"
}

# Restart the tunnels
restart_tunnels() {
    print_status "Restarting SSH tunnels..."
    stop_tunnels
    sleep 2
    start_tunnels
}

# Show status of tunnels
status_tunnels() {
    echo -e "${BLUE}=== SSH Tunnel Status ===${NC}"
    
    if check_running; then
        print_status "Tunnels are RUNNING"
        echo ""
        echo "Active processes:"
        if [ -f "$PID_FILE" ]; then
            while read pid; do
                if ps -p "$pid" > /dev/null 2>&1; then
                    ps -f -p "$pid" | grep -v "PID"
                fi
            done < "$PID_FILE"
        fi
    else
        print_warning "Tunnels are NOT running"
    fi
    
    echo ""
    echo "All autossh processes:"
    if pgrep -f "autossh" > /dev/null; then
        ps aux | grep "[a]utossh"
    else
        echo "No autossh processes found"
    fi
}

# Test connection to remote host
test_connection() {
    print_status "Testing SSH connection to $REMOTE_HOST..."
    if ssh -o ConnectTimeout=5 -o BatchMode=yes "$REMOTE_HOST" exit 2>/dev/null; then
        print_status "Connection to $REMOTE_HOST successful!"
    else
        print_error "Cannot connect to $REMOTE_HOST"
        echo "Please check:"
        echo "  - SSH keys are set up correctly"
        echo "  - $REMOTE_HOST hostname is in ~/.ssh/config or /etc/hosts"
        echo "  - Network connectivity"
        exit 1
    fi
}

# Show logs (if running via systemd)
show_logs() {
    print_info "Showing recent autossh activity from system logs..."
    journalctl -t autossh -n 50 --no-pager 2>/dev/null || echo "No systemd logs available (not running as service)"
}

# Emergency kill all autossh
kill_all() {
    print_warning "Emergency: Killing ALL autossh processes..."
    pkill -9 autossh 2>/dev/null
    [ -f "$PID_FILE" ] && rm -f "$PID_FILE"
    print_status "All autossh processes killed"
}

# Show help
show_help() {
    echo "AutoSSH Tunnel Manager"
    echo ""
    echo "Manages SSH tunnels to $REMOTE_HOST:"
    echo "  - Port "$REMOTE_WEB" -> localhost:9009"
    echo "  - Port "$REMOTE_SSH" -> localhost:22"
    echo ""
    echo "Usage: $0 {command}"
    echo ""
    echo "Commands:"
    echo "  start       - Start the SSH tunnels"
    echo "  stop        - Stop the tunnels (with proper cleanup)"
    echo "  restart     - Restart the tunnels"
    echo "  status      - Show tunnel status"
    echo "  test        - Test SSH connection to remote host"
    echo "  logs        - Show recent logs"
    echo "  kill-all    - Emergency: force kill all autossh processes"
    echo "  help        - Show this help message"
    echo ""
}

# Main script logic
case "$1" in
    start)
        start_tunnels
        ;;
    stop)
        stop_tunnels
        ;;
    restart)
        restart_tunnels
        ;;
    status)
        status_tunnels
        ;;
    test)
        test_connection
        ;;
    logs)
        show_logs
        ;;
    kill-all)
        kill_all
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        print_error "Invalid command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac

exit 0
